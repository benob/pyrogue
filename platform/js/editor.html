<!doctype HTML>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <title>Pyrogue</title>
		<script src="https://codemirror.net/lib/codemirror.js"></script>
		<link rel="stylesheet" href="https://codemirror.net/lib/codemirror.css">
		<link rel="stylesheet" href="https://codemirror.net/theme/solarized.css">
		<script src="https://codemirror.net/mode/python/python.js"></script>
    <style>
			body {
				margin-left: 3em;
				margin-right: 3em;
			}
			#canvas-container {
				text-align: center;
				width: 100%;
				background: black;
				border-radius: 20px 20px 0px 0px;
			}
			#buttons-container {
				background: black;
				color: white;
				padding: .3em 1em;
				font-family: monospace;
				font-size: 13px;
			}
			#canvas {
				background: rgb(16, 16, 32);
				margin-top: 2em;
				width: 320px;
				height: 240px;
			}
			#script {
				width: 100%;
			}
			#stdout {
				width: 100%;
				height: 200px;
				overflow-y: scroll;
				background: black;
				color: white;
				font-family: monospace;
				font-size: 13px;
			}
			.CodeMirror {
				height: auto;
			}
		</style>
	</head>
	<body>
		<div id="canvas-container"><canvas width="320" height="240" id="canvas"></canvas></div>
		<div id="buttons-container">
		Pyrogue: <a href="#" onclick="press_run(this)">Run</a>
		</div>
		<div id="script-container"><textarea id="script" rows="8">
import rl

rl.init('test', 320, 240)

def update(event):
    print(event)
    color = rl.color(rl.random_int(0, 255), rl.random_int(0, 255), rl.random_int(0, 255))
    rl.fill_rect(rl.random_int(0, 320), rl.random_int(0, 240), 50, 50, color)

rl.run(update)</textarea></div>
		<div id="stdout"></div>
    <script type='text/javascript'>
			var stdout = document.getElementById('stdout');
      var Module = {
          canvas: document.getElementById('canvas'),
					'arguments': ['game.zip'],
					preRun: [function() {
						ENV.SDL_EMSCRIPTEN_KEYBOARD_ELEMENT = '#canvas';
					}],
					print: function(text) {
						stdout.innerText += text + '\n';
					},
					printErr: function(text) {
						stdout.innerText += text + '\n';
					},
      };
			var running = false;
			function press_run(button) {
				if(running) {
					pyrogue_quit();
					running = false;
					button.innerText = 'Run';
				} else {
					stdout.innerText = '';
					running = true;
					button.innerText = 'Stop';
					let code = codeEditor.getValue();
					document.getElementById('canvas').focus();
					console.log('starting');
					pyrogue_run_string(code);
					pyrogue_quit();
					console.log('finished');
					running = false;
					button.innerText = 'Start';
				}

			}
    </script>
    <script async type="text/javascript" src="pyrogue.preload.js"></script>
    <script async type="text/javascript" src="pyrogue.js"></script>
		<script>
			let was_init = false;
			function pyrogue_init() {
				Module.ccall('pyrogue_init', null, []);
				was_init = true;
			}
			function pyrogue_shutdown() {
				Module.ccall('pyrogue_shutdown', null, []);
			}
			function pyrogue_run_string(script) {
				pyrogue_quit();
				if(was_init) pyrogue_shutdown();
				pyrogue_init();
				Module.ccall('pyrogue_run_string', null, ['string', 'string'], ['code', script]);
			}
			function pyrogue_run(filename) {
				return Module.ccall('pyrogue_run', 'integer', ['string'], [filename]);
			}
			function pyrogue_quit() {
				Module.ccall('pyrogue_quit', null, []);
			}
			let script = document.getElementById('script');
			var codeEditor = CodeMirror.fromTextArea(script, {
				mode: 'python',
				lineNumbers: true,
				theme: 'solarized dark',
				viewportMargin: Infinity,
			});
		</script>
	</body>
</html>
