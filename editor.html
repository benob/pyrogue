<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <title>Editor</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/4.3/examples/cover/">
		<!-- Bootstrap core CSS -->
		<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
		<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

		<script src="https://codemirror.net/lib/codemirror.js"></script>
		<link rel="stylesheet" href="https://codemirror.net/lib/codemirror.css">
		<link rel="stylesheet" href="https://codemirror.net/theme/solarized.css">
		<script src="https://codemirror.net/mode/python/python.js"></script>
<style>
body {
	margin: 1em;
	font-family: monospace;
}

.pyrogue-row {
	display: flex;
	flex-wrap: wrap;
	justify-content: center;
	align-items: stretch;
}
.pyrogue-col {
	margin: 5px;
	width: 640px;
	height: 480px;
	max-width: 100%;
	display:flex;
	align-items: flex-start;
	flex-direction: column;
}
#display {
	width: 100%;
	height: 100%;
}
#canvas {
	margin-top: auto;
	margin-bottom: auto;
}
#editor {
	flex-grow: 1;
	overflow: hidden;
}
.result {
	background: black;
	overflow: hidden;
	flex-grow: 1;
	width: 100%;
}
.controls {
	flex-grow: 0;
	padding-top: 5px;
}

.CodeMirror {
	width: 100%;
	height: 100%;
}
.btn {
	border-radius: 0px;
	padding: 1px 6px;
	margin-bottom: 5px;
}
#canvas {
	width: 100%;
	height: 100%;
}
#stdout {
	width: 100%;
	height: 100%;
	overflow-y: scroll;
	-color: #d7d4f0;
	color: #839496;
	font-family: monospace;
	font-size: 13px;
}
.stderr {
	color: #cb4b16;
}
</style>
  </head>

	<body>
		<header class="masthead mb-auto">
			<div class="inner">
				<h3 class="masthead-brand text-center">Pyrogue</h3>
				<p class="text-center">Embedded micropython for making roguelikes</p>
			</div>
		</header>

		<main role="main" class="inner cover">
			<!--<div class="container">-->
				<div class="pyrogue-row">
					<div class="pyrogue-col">
						<div class="result">
							<div id="display"><canvas width="320" height="240" id="canvas"></canvas></div>
							<div id="stdout" style="display: none">Ready</div>
						</div>
						<div class="controls">
							<button class="btn btn-primary" onclick="press_run(this)">Run</button>
							<button id="console-button" class="btn btn-outline-secondary" onclick="toggle_console(this)">Console</button>
							<button class="btn btn-outline-secondary">Fullscreen</button>
						</div>
					</div>
					<div class="pyrogue-col">
						<textarea id="editor">
import rl

WIDTH, HEIGHT = 320, 240
rl.init_display('test', WIDTH, HEIGHT)

def update(event):
    color = rl.random_color()
    rl.fill_rect(rl.random_int(0, WIDTH - 1), rl.random_int(0, HEIGHT - 1), 50, 50, color)

rl.run(update)</textarea>
						<div class="controls">
							<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#share-modal" onclick="share_code()">Share</button>
							<a class="btn btn-outline-secondary" href="documentation.html" target='documentation'>Docs</a> 
							<a class="btn btn-outline-secondary" href="assets.html" target='assets'>Assets</a> 
							<a class="btn btn-outline-secondary" href="https://github.com/benob/pyrogue" target='github'>Github</a> 
						</div>
					</div>
				</div>
				<!--</div>-->

			<!-- Modal -->
			<div class="modal" id="share-modal" tabindex="-1" role="dialog" aria-labelledby="share-modal-title" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="share-modal-title">Share script</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<div class="modal-body">
							<p>URL copied to clipboard.</p>
							<p><textarea id="share-url" rows="10" cols="40"></textarea></p>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
						</div>
					</div>
				</div>
			</div>

		</main>

		<script>
			function escape_text(str) {
				return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
			}
			var stdout = document.getElementById('stdout');
      var Module = {
					canvas_fit_parent: 1,
          canvas: document.getElementById('canvas'),
					'arguments': ['game.zip'],
					preRun: [function() {
						ENV.SDL_EMSCRIPTEN_KEYBOARD_ELEMENT = '#canvas';
					}],
					print: function(text) {
						if(running) {
							stdout.innerHTML += escape_text(text) + '<br>';
							update_console_button(1);
							stdout.scrollTop = stdout.scrollHeight;
						}
					},
					printErr: function(text) {
						if(running) {
							stdout.innerHTML += '<span class="stderr">'+ escape_text(text) + '</span><br>';
							update_console_button(2);
							stdout.scrollTop = stdout.scrollHeight;
						}
					},
      };
			var running = false;
			function press_run(button) {
				if(running) {
					pyrogue_quit();
					running = false;
					button.innerText = 'Run';
				} else {
					stdout.innerText = '';
					running = true;
					button.innerText = 'Stop';
					let code = codeEditor.getValue();
					document.getElementById('canvas').focus();
					console.log('starting');
					showing_console = true;
					update_console_button(0);
					pyrogue_run_string(code);
					pyrogue_quit();
					console.log('finished');
					running = false;
					button.innerText = 'Run';
					//update_console_button(0);
				}
			}
			function share_code() {
				let code = codeEditor.getValue();
				let url = window.location.href.split("#", 1)[0] + '#' + escape(code);

				let dummy = document.createElement('input');
				dummy.value = url;
				document.body.appendChild(dummy);
				dummy.select();
				document.execCommand('copy');
				document.body.removeChild(dummy);

				let input = document.getElementById('share-url');
				input.value = url;
			}
    </script>
    <script async type="text/javascript" src="pyrogue.preload.editor.js"></script>
    <script async type="text/javascript" src="pyrogue.js"></script>
		<script>
			let was_init = false;
			function pyrogue_init() {
				Module.ccall('pyrogue_init', null, ['string'], ['editor.zip']);
				was_init = true;
			}
			function pyrogue_shutdown() {
				Module.ccall('pyrogue_shutdown', null, []);
			}
			function pyrogue_run_string(script) {
				pyrogue_quit();
				if(was_init) pyrogue_shutdown();
				pyrogue_init();
				Module.ccall('pyrogue_run_string', null, ['string', 'string'], ['code', script]);
			}
			function pyrogue_run(filename) {
				return Module.ccall('pyrogue_run', 'integer', ['string'], [filename]);
			}
			function pyrogue_quit() {
				Module.ccall('pyrogue_quit', null, []);
			}
			let editor = document.getElementById('editor');
			var codeEditor = CodeMirror.fromTextArea(editor, {
				mode: 'python',
				lineNumbers: true,
				theme: 'solarized dark',
				extraKeys: {
					Tab: (cm) => cm.execCommand("indentMore"),
					"Shift-Tab": (cm) => cm.execCommand("indentLess"),
				},
			});
			let url_parts = document.location.href.split('#');
			if(url_parts.length == 2) {
				let code = unescape(url_parts[1]);
				console.log('code=', code);
				if(code.length > 0) codeEditor.setValue(code);
			}
			var showing_console = true;
			function update_console_button(flag) {
				let element = document.getElementById('console-button');
				let display = document.getElementById('display');
				let stdout = document.getElementById('stdout');
				if(showing_console) {
					if(flag) element.innerText = 'Console*';
					else element.innerText = 'Console';
					display.style.display = '';
					stdout.style.display = 'none';
				} else {
					element.innerText = 'Display';
					display.style.display = 'none';
					stdout.style.display = '';
				}
				if(flag == 2) {
					$(element).addClass('btn-outline-danger').removeClass('btn-outline-secondary');
				} else {
					$(element).removeClass('btn-outline-danger').addClass('btn-outline-secondary');
				}
			}
			function toggle_console(element) {
				showing_console = !showing_console;
				update_console_button(0);
			}
		</script>
	</body>
</html>
